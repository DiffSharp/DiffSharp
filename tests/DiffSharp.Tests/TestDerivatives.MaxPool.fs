// Copyright (c) 2016-     University of Oxford (Atilim Gunes Baydin <gunes@robots.ox.ac.uk>)
// and other contributors, see LICENSE in root of repository.
//
// BSD 2-Clause License. See LICENSE in root of repository.

namespace Tests

open NUnit.Framework
open DiffSharp
open DiffSharp.Util

#nowarn "0058"

[<TestFixture>]
type TestDerivativesMaxPool () =

    [<Test>]
    member _.TestDerivativeMaxPool1D () =
        for combo in Combos.FloatingPointExcept16s do
            let fwdx = combo.tensor([[[-2.1704, -1.1558,  2.5995,  1.3858, -1.3157, -0.3179,  0.9593,  -2.1432,  0.7169, -1.7999],
                                     [ 0.4564, -0.2262,  0.3495,  0.4587, -0.3858,  0.2349,  0.2978,  0.6288,  1.1539,  0.2121]],

                                    [[ 0.6654,  0.7151,  0.9980,  0.1321, -2.0009, -1.1897,  1.0608,  -1.8059, -0.2344,  1.6387],
                                     [ 1.1872, -2.2679, -0.0297, -0.2067, -1.5622, -0.3916,  0.6039,  -1.1469,  0.4560,  1.2069]]])
            let fwdx = fwdx.forwardDiff(combo.tensor([[[-0.3247,  1.0735, -1.7455,  0.8657, -0.5433,  1.7256,  0.7251, -0.3657, -0.8445,  1.6669],
                                                         [ 0.7586, -0.1351, -1.4672, -0.7769, -1.1811,  0.2663,  0.0386,  0.7750,  1.8680,  0.8252]],

                                                        [[-0.2242,  1.1212,  0.4791,  0.4936, -0.9529,  0.1540,  0.4039, -0.0324, -2.2168, -1.6637],
                                                         [ 1.5662,  0.2435, -1.0502, -0.2772,  0.8112, -0.4306, -0.2975,  0.4397,  0.4384,  1.4232]]]))
            let fwdz = fwdx.maxpool1d(3)
            let fwdzCorrect = combo.tensor([[[ 2.5995,  1.3858,  0.9593],
                                               [ 0.4564,  0.4587,  1.1539]],

                                              [[ 0.9980,  0.1321,  1.0608],
                                               [ 1.1872, -0.2067,  0.6039]]])
            let fwdzd = fwdz.derivative
            let fwdzdCorrect = combo.tensor([[[-1.7455,  0.8657,  0.7251],
                                                [ 0.7586, -0.7769,  1.8680]],
                                   
                                               [[ 0.4791,  0.4936,  0.4039],
                                                [ 1.5662, -0.2772, -0.2975]]])

            let revx = combo.tensor([[[-2.1704, -1.1558,  2.5995,  1.3858, -1.3157, -0.3179,  0.9593,  -2.1432,  0.7169, -1.7999],
                                     [ 0.4564, -0.2262,  0.3495,  0.4587, -0.3858,  0.2349,  0.2978,  0.6288,  1.1539,  0.2121]],

                                    [[ 0.6654,  0.7151,  0.9980,  0.1321, -2.0009, -1.1897,  1.0608,  -1.8059, -0.2344,  1.6387],
                                     [ 1.1872, -2.2679, -0.0297, -0.2067, -1.5622, -0.3916,  0.6039,  -1.1469,  0.4560,  1.2069]]]).reverseDiff()
            let revz = revx.maxpool1d(3)
            let revzCorrect = combo.tensor([[[ 2.5995,  1.3858,  0.9593],
                                               [ 0.4564,  0.4587,  1.1539]],

                                              [[ 0.9980,  0.1321,  1.0608],
                                               [ 1.1872, -0.2067,  0.6039]]])
            revz.reverse(combo.tensor([[[ 0.5382,  0.0542,  1.2613],
                                         [ 0.1226,  1.9195,  0.2829]],

                                        [[-0.3677, -0.3066,  0.5523],
                                         [-0.3306,  1.3332,  0.8371]]]))
            let revxd = revx.derivative
            let revxdCorrect = combo.tensor([[[ 0.0000,  0.0000,  0.5382,  0.0542,  0.0000,  0.0000,  1.2613,  0.0000,  0.0000,  0.0000],
                                                [ 0.1226,  0.0000,  0.0000,  1.9195,  0.0000,  0.0000,  0.0000,  0.0000,  0.2829,  0.0000]],
                                   
                                               [[ 0.0000,  0.0000, -0.3677, -0.3066,  0.0000,  0.0000,  0.5523,  0.0000,  0.0000,  0.0000],
                                                [-0.3306,  0.0000,  0.0000,  1.3332,  0.0000,  0.0000,  0.8371,  0.0000,  0.0000,  0.0000]]])

            Assert.True(fwdz.allclose(fwdzCorrect, 0.01))
            Assert.True(fwdzd.allclose(fwdzdCorrect, 0.01))
            Assert.True(revz.allclose(revzCorrect, 0.01))
            Assert.True(revxd.allclose(revxdCorrect, 0.01))

    [<Test>]
    member _.TestDerivativeMaxUnpool1D () =
        for combo in Combos.FloatingPointExcept16s do
            let indices = combo.tensor([[[2, 3, 6], [0, 3, 8]], [[2, 3, 6], [0, 3, 6]]], dtype=Dtype.Int32)
            let fwdx = combo.tensor([[[ 2.5995,  1.3858,  0.9593],
                                        [ 0.4564,  0.4587,  1.1539]],
                           
                                       [[ 0.9980,  0.1321,  1.0608],
                                        [ 1.1872, -0.2067,  0.6039]]])
            let fwdx = fwdx.forwardDiff(combo.tensor([[[ 0.9451,  0.1785, -1.1651],
                                                        [ 0.6300, -0.0456,  0.7958]],
                                           
                                                       [[-0.1445, -0.9256, -0.3704],
                                                        [-0.7281, -0.8475, -2.2073]]]))
            let fwdz = fwdx.maxunpool1d(indices, 3)
            let fwdzCorrect = combo.tensor([[[ 0.0000,  0.0000,  2.5995,  1.3858,  0.0000,  0.0000,  0.9593,  0.0000,  0.0000],
                                              [ 0.4564,  0.0000,  0.0000,  0.4587,  0.0000,  0.0000,  0.0000,  0.0000,  1.1539]],
                                 
                                             [[ 0.0000,  0.0000,  0.9980,  0.1321,  0.0000,  0.0000,  1.0608,  0.0000,  0.0000],
                                              [ 1.1872,  0.0000,  0.0000, -0.2067,  0.0000,  0.0000,  0.6039,  0.0000,  0.0000]]])
            let fwdzd = fwdz.derivative
            let fwdzdCorrect = combo.tensor([[[ 0.0000,  0.0000,  0.9451,  0.1785,  0.0000,  0.0000, -1.1651,  0.0000,  0.0000],
                                                [ 0.6300,  0.0000,  0.0000, -0.0456,  0.0000,  0.0000,  0.0000,  0.0000,  0.7958]],
                                   
                                               [[ 0.0000,  0.0000, -0.1445, -0.9256,  0.0000,  0.0000, -0.3704,  0.0000,  0.0000],
                                                [-0.7281,  0.0000,  0.0000, -0.8475,  0.0000,  0.0000, -2.2073,  0.0000,  0.0000]]])

            let revx = combo.tensor([[[ 2.5995,  1.3858,  0.9593],
                                        [ 0.4564,  0.4587,  1.1539]],
                           
                                       [[ 0.9980,  0.1321,  1.0608],
                                        [ 1.1872, -0.2067,  0.6039]]]).reverseDiff()
            let revz = revx.maxunpool1d(indices, 3)
            let revzCorrect = combo.tensor([[[ 0.0000,  0.0000,  2.5995,  1.3858,  0.0000,  0.0000,  0.9593,  0.0000,  0.0000],
                                              [ 0.4564,  0.0000,  0.0000,  0.4587,  0.0000,  0.0000,  0.0000,  0.0000,  1.1539]],
                                 
                                             [[ 0.0000,  0.0000,  0.9980,  0.1321,  0.0000,  0.0000,  1.0608,  0.0000,  0.0000],
                                              [ 1.1872,  0.0000,  0.0000, -0.2067,  0.0000,  0.0000,  0.6039,  0.0000,  0.0000]]])
            revz.reverse(combo.tensor([[[0.9784, 0.1157, 0.5180, 0.2987, 0.7666, 0.2534, 0.8825, 0.3584, 0.9782],
                                          [0.5410, 0.9465, 0.5629, 0.6000, 0.0979, 0.1738, 0.2395, 0.2611, 0.3394]],
                             
                                         [[0.0616, 0.4017, 0.6919, 0.5744, 0.3560, 0.2461, 0.6728, 0.3323, 0.8579],
                                          [0.4799, 0.5880, 0.0471, 0.8489, 0.5679, 0.1894, 0.1387, 0.3290, 0.1449]]]))
            let revxd = revx.derivative
            let revxdCorrect = combo.tensor([[[0.5180, 0.2987, 0.8825],
                                                [0.5410, 0.6000, 0.3394]],
                                   
                                               [[0.6919, 0.5744, 0.6728],
                                                [0.4799, 0.8489, 0.1387]]])

            Assert.True(fwdz.allclose(fwdzCorrect, 0.01))
            Assert.True(fwdzd.allclose(fwdzdCorrect, 0.01))
            Assert.True(revz.allclose(revzCorrect, 0.01))
            Assert.True(revxd.allclose(revxdCorrect, 0.01))

    [<Test>]
    member _.TestDerivativeMaxPool2D () =
        for combo in Combos.FloatingPointExcept16s do
            let fwdx = combo.tensor([[[[ 0.7372,  0.7090,  0.9216,  0.3363,  1.0141, -0.7642,  0.3801, -0.9568],
                                         [-0.3520, -1.2336,  1.8489,  0.9929, -0.8138,  0.0978, -1.3206, -1.5434],
                                         [ 0.6883, -0.2346,  0.1735,  0.6695, -1.9122,  1.1338, -0.1248,  0.2164],
                                         [-1.1349,  0.3008, -0.1635, -1.0362, -0.6487, -0.8422, -0.4334,  1.0604],
                                         [-2.1562, -0.1079,  0.5744, -0.7275,  1.0254, -0.0508, -0.0525, -0.0746],
                                         [-0.7494,  0.6819, -1.7327, -0.4838, -0.6120,  1.6331,  0.1797, -0.6068],
                                         [ 0.6400,  0.1389,  0.3033,  0.3195,  0.9934,  1.2455, -1.0953,  0.9922],
                                         [ 0.2375,  0.6003, -1.1614,  1.0146,  0.2100, -1.0145, -0.1933,  1.1415]],
                           
                                        [[-0.0819,  0.2091,  0.4351,  1.7527, -1.1970,  2.1048,  1.0200, -0.5153],
                                         [ 1.0867, -1.8738, -0.2754, -0.5089,  0.8850, -0.4751, -0.7820,  1.4476],
                                         [-0.9072,  0.9977, -0.9106, -0.3171, -1.2444,  0.7102,  0.5656,  1.2660],
                                         [ 0.1986, -0.4967,  0.2384, -0.6551,  1.0156,  0.0520, -0.1964,  1.1367],
                                         [ 0.8948,  2.2070,  0.9938,  0.5311, -1.0674,  0.3894,  0.4192, -0.6235],
                                         [ 2.7646, -0.6509,  0.4669, -1.8774, -0.6341,  0.5113,  1.2398,  2.5090],
                                         [ 1.0722,  0.8162, -2.3271,  1.3826,  1.3832,  0.6205, -0.9138, -0.8237],
                                         [-0.0688, -1.6786,  0.1672, -0.7255, -0.1228, -0.1603, -2.1906, -2.6372]]],
                           
                           
                                       [[[-1.0461,  0.4063,  0.2085, -0.7598, -1.3893, -0.8866,  1.0594, -0.6184],
                                         [ 2.1120, -0.6475, -0.3964,  0.0378,  0.0138, -0.1672,  0.9265, -1.7734],
                                         [-0.2313,  0.6284, -0.0508, -0.1014, -0.5059,  0.8666, -0.7010, -0.5073],
                                         [ 0.1709,  0.2466,  0.1781, -1.6740, -0.0251, -1.4144, -2.1012,  0.3922],
                                         [ 0.9141,  0.6582, -0.0826, -0.7104,  1.7133,  1.2406,  1.1415, -0.6222],
                                         [-2.1525, -0.2996, -1.3787,  0.0336, -1.4643,  0.6534,  0.3996,  0.3145],
                                         [-0.3298,  0.3855, -0.5100,  1.2770,  0.5306, -0.6604, -0.0489,  0.0609],
                                         [-0.1552, -1.1218, -0.8435,  0.2365,  1.4428,  0.4234, -1.1083, -1.3874]],
                           
                                        [[ 0.0511,  0.1216, -1.0103, -1.2529,  1.7200, -0.0225,  0.7446, -0.8076],
                                         [ 0.2543,  1.4250,  0.7869,  0.0526, -2.1598,  1.8228, -0.4628,  1.4234],
                                         [ 0.5492,  0.8668,  0.2120,  0.6599, -1.0934, -1.3726,  0.4788, -0.1171],
                                         [ 0.5121,  1.2607, -0.4565,  0.5448, -2.5025, -0.5503, -1.3373,  0.1711],
                                         [-0.3939, -0.6382, -0.0899, -1.4706,  0.4580,  0.3304,  1.8958,  0.1178],
                                         [ 0.1109,  0.2468,  0.3485, -0.0960, -0.0432, -0.3026, -1.9750,  0.4057],
                                         [-1.1117, -0.3422,  1.2130, -1.1206,  0.9506, -0.7723,  0.3162, -0.5487],
                                         [ 0.6304, -0.9149,  0.6075, -0.5371,  1.5875, -0.2979, -0.5832, -3.0311]]]])
            let fwdx = fwdx.forwardDiff(combo.tensor([[[[-0.7337, -1.3648,  1.0776,  0.2407,  0.4805, -2.3233, -0.5350,  0.2349],
                                                         [ 0.5049, -1.1209, -0.5273,  0.5923,  0.2016, -0.9050, -0.1330, -0.1143],
                                                         [ 0.1170,  0.9821, -1.5198,  0.8396,  0.9480, -1.1543,  0.5911, -0.5788],
                                                         [-0.7547,  1.5573, -1.0888,  1.1832,  0.2259,  0.7667, -1.8830,  1.5575],
                                                         [ 1.8945,  1.2214, -0.7537, -2.2445,  2.2856, -0.3581, -1.2650, -1.2537],
                                                         [ 0.9016, -0.9378,  0.3730,  0.3823,  0.5864, -0.9494,  1.9570,  0.3918],
                                                         [ 1.4439, -0.5949, -0.0530, -1.2888,  0.6724, -2.1929, -0.0656,  1.4826],
                                                         [ 1.0679, -0.4129,  1.4264, -0.5726,  1.5709, -2.1192,  0.9934,  0.5601]],
                                           
                                                        [[ 0.8278,  0.3305,  0.4650,  0.0205, -0.4212,  0.2386,  0.2713, -0.1324],
                                                         [ 0.6960,  1.3936,  0.5689, -1.1607,  0.7279, -1.0106, -1.0930, -0.0435],
                                                         [ 0.3146,  0.2892,  0.0992,  0.4875,  0.0519,  0.8227,  2.1785,  0.1240],
                                                         [-0.1070,  1.4169, -1.5649, -0.9627, -0.1553, -1.6912, -0.2387,  1.4843],
                                                         [ 1.0833,  1.5409,  1.0983,  0.7896,  0.0561, -1.1853,  1.2164, -0.2477],
                                                         [-2.4074, -0.8374,  0.7228, -0.8311, -0.1571,  0.7585, -0.0388,  1.2265],
                                                         [ 0.8151,  0.5675, -1.2308,  0.5890, -1.0173,  0.0685, -1.4259, -0.0152],
                                                         [-0.3683,  0.3478, -0.3144, -1.6980, -1.0717,  1.0022, -0.1882, -0.2628]]],
                                           
                                           
                                                       [[[-0.1276,  0.3947,  0.0067, -0.0319,  1.2249,  0.8052, -0.0976, -0.6969],
                                                         [-0.1721,  1.2421, -1.3382,  0.8105,  1.2408,  0.0398,  0.6267,  0.2405],
                                                         [ 0.8025,  1.2815, -1.0382,  1.9981,  1.0302,  0.7142, -0.1895,  0.6839],
                                                         [ 1.3058,  0.5244, -0.2134, -0.9721,  0.8622, -1.0595, -1.2676, -0.4594],
                                                         [ 0.0034,  1.2082, -0.8065, -1.3570, -0.6702, -0.7155,  1.4782,  0.4554],
                                                         [ 1.9114,  0.0033,  0.2951,  0.6574,  0.1122, -0.9725,  1.1244, -0.0866],
                                                         [ 0.2964,  0.4166, -0.9363, -1.6471, -0.9568, -1.6350,  1.2974, -0.7931],
                                                         [-2.0031,  0.6322,  0.1063,  0.6449,  0.8070, -0.6169, -0.0319,  0.4695]],
                                           
                                                        [[ 1.2686,  0.9119, -1.7762,  0.2893, -1.6885, -1.0427, -1.2432,  1.3702],
                                                         [-1.9922,  0.2098, -0.3885,  0.0719, -1.7845,  1.6076, -1.1755,  0.4668],
                                                         [-0.2193, -1.0314,  0.4875,  0.2942, -0.4408,  0.4081,  2.1808,  0.3206],
                                                         [-0.5614,  0.4319,  2.1275, -1.0575, -1.6521,  0.2688, -0.3607, -0.1448],
                                                         [ 1.0357,  0.0210, -0.2928,  1.1564,  0.8043, -1.0873, -1.3117, -1.6104],
                                                         [-0.1354,  0.1832,  0.2811, -1.5012,  0.9051,  1.0796,  0.3448,  1.7928],
                                                         [-0.2357, -1.7013, -0.2552,  0.3293, -0.6618, -1.7520, -0.2757, -0.3190],
                                                         [-0.8181,  1.4611,  0.6737,  0.6333, -1.2758, -0.0336,  0.7365,  0.0952]]]]))
            let fwdz = fwdx.maxpool2d(3)
            let fwdzCorrect = combo.tensor([[[[1.8489, 1.1338],
                                               [0.6819, 1.6331]],
                                 
                                              [[1.0867, 2.1048],
                                               [2.7646, 1.0156]]],
                                 
                                 
                                             [[[2.1120, 0.8666],
                                               [0.9141, 1.7133]],
                                 
                                              [[1.4250, 1.8228],
                                               [1.2607, 0.5448]]]])
            let fwdzd = fwdz.derivative
            let fwdzdCorrect = combo.tensor([[[[-0.5273, -1.1543],
                                                 [-0.9378, -0.9494]],
                                   
                                                [[ 0.6960,  0.2386],
                                                 [-2.4074, -0.1553]]],
                                   
                                   
                                               [[[-0.1721,  0.7142],
                                                 [ 0.0034, -0.6702]],
                                   
                                                [[ 0.2098,  1.6076],
                                                 [ 0.4319, -1.0575]]]])

            let revx = combo.tensor([[[[ 0.7372,  0.7090,  0.9216,  0.3363,  1.0141, -0.7642,  0.3801, -0.9568],
                                         [-0.3520, -1.2336,  1.8489,  0.9929, -0.8138,  0.0978, -1.3206, -1.5434],
                                         [ 0.6883, -0.2346,  0.1735,  0.6695, -1.9122,  1.1338, -0.1248,  0.2164],
                                         [-1.1349,  0.3008, -0.1635, -1.0362, -0.6487, -0.8422, -0.4334,  1.0604],
                                         [-2.1562, -0.1079,  0.5744, -0.7275,  1.0254, -0.0508, -0.0525, -0.0746],
                                         [-0.7494,  0.6819, -1.7327, -0.4838, -0.6120,  1.6331,  0.1797, -0.6068],
                                         [ 0.6400,  0.1389,  0.3033,  0.3195,  0.9934,  1.2455, -1.0953,  0.9922],
                                         [ 0.2375,  0.6003, -1.1614,  1.0146,  0.2100, -1.0145, -0.1933,  1.1415]],
                           
                                        [[-0.0819,  0.2091,  0.4351,  1.7527, -1.1970,  2.1048,  1.0200, -0.5153],
                                         [ 1.0867, -1.8738, -0.2754, -0.5089,  0.8850, -0.4751, -0.7820,  1.4476],
                                         [-0.9072,  0.9977, -0.9106, -0.3171, -1.2444,  0.7102,  0.5656,  1.2660],
                                         [ 0.1986, -0.4967,  0.2384, -0.6551,  1.0156,  0.0520, -0.1964,  1.1367],
                                         [ 0.8948,  2.2070,  0.9938,  0.5311, -1.0674,  0.3894,  0.4192, -0.6235],
                                         [ 2.7646, -0.6509,  0.4669, -1.8774, -0.6341,  0.5113,  1.2398,  2.5090],
                                         [ 1.0722,  0.8162, -2.3271,  1.3826,  1.3832,  0.6205, -0.9138, -0.8237],
                                         [-0.0688, -1.6786,  0.1672, -0.7255, -0.1228, -0.1603, -2.1906, -2.6372]]],
                           
                           
                                       [[[-1.0461,  0.4063,  0.2085, -0.7598, -1.3893, -0.8866,  1.0594, -0.6184],
                                         [ 2.1120, -0.6475, -0.3964,  0.0378,  0.0138, -0.1672,  0.9265, -1.7734],
                                         [-0.2313,  0.6284, -0.0508, -0.1014, -0.5059,  0.8666, -0.7010, -0.5073],
                                         [ 0.1709,  0.2466,  0.1781, -1.6740, -0.0251, -1.4144, -2.1012,  0.3922],
                                         [ 0.9141,  0.6582, -0.0826, -0.7104,  1.7133,  1.2406,  1.1415, -0.6222],
                                         [-2.1525, -0.2996, -1.3787,  0.0336, -1.4643,  0.6534,  0.3996,  0.3145],
                                         [-0.3298,  0.3855, -0.5100,  1.2770,  0.5306, -0.6604, -0.0489,  0.0609],
                                         [-0.1552, -1.1218, -0.8435,  0.2365,  1.4428,  0.4234, -1.1083, -1.3874]],
                           
                                        [[ 0.0511,  0.1216, -1.0103, -1.2529,  1.7200, -0.0225,  0.7446, -0.8076],
                                         [ 0.2543,  1.4250,  0.7869,  0.0526, -2.1598,  1.8228, -0.4628,  1.4234],
                                         [ 0.5492,  0.8668,  0.2120,  0.6599, -1.0934, -1.3726,  0.4788, -0.1171],
                                         [ 0.5121,  1.2607, -0.4565,  0.5448, -2.5025, -0.5503, -1.3373,  0.1711],
                                         [-0.3939, -0.6382, -0.0899, -1.4706,  0.4580,  0.3304,  1.8958,  0.1178],
                                         [ 0.1109,  0.2468,  0.3485, -0.0960, -0.0432, -0.3026, -1.9750,  0.4057],
                                         [-1.1117, -0.3422,  1.2130, -1.1206,  0.9506, -0.7723,  0.3162, -0.5487],
                                         [ 0.6304, -0.9149,  0.6075, -0.5371,  1.5875, -0.2979, -0.5832, -3.0311]]]]).reverseDiff()
            let revz = revx.maxpool2d(3)
            let revzCorrect = combo.tensor([[[[1.8489, 1.1338],
                                               [0.6819, 1.6331]],
                                 
                                              [[1.0867, 2.1048],
                                               [2.7646, 1.0156]]],
                                 
                                 
                                             [[[2.1120, 0.8666],
                                               [0.9141, 1.7133]],
                                 
                                              [[1.4250, 1.8228],
                                               [1.2607, 0.5448]]]])
            revz.reverse(combo.tensor([[[[-1.0671,  0.1340],
                                          [-0.2743, -0.3197]],

                                         [[ 0.8588, -1.5268],
                                          [ 0.5205,  0.5109]]],


                                        [[[ 1.9620,  0.1845],
                                          [-2.5131, -0.9616]],

                                         [[ 0.7820,  0.4960],
                                          [-0.7865, -0.1536]]]]))
            let revxd = revx.derivative
            let revxdCorrect = combo.tensor([[[[ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000, -1.0671,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.1340,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000, -0.2743,  0.0000,  0.0000,  0.0000, -0.3197,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000]],
                                   
                                                [[ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000, -1.5268,  0.0000,  0.0000],
                                                 [ 0.8588,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.5109,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 0.5205,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000]]],
                                   
                                   
                                               [[[ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 1.9620,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.1845,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [-2.5131,  0.0000,  0.0000,  0.0000, -0.9616,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000]],
                                   
                                                [[ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000,  0.7820,  0.0000,  0.0000,  0.0000,  0.4960,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000, -0.7865,  0.0000, -0.1536,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000]]]])

            Assert.True(fwdz.allclose(fwdzCorrect, 0.01))
            Assert.True(fwdzd.allclose(fwdzdCorrect, 0.01))
            Assert.True(revz.allclose(revzCorrect, 0.01))
            Assert.True(revxd.allclose(revxdCorrect, 0.01))

    [<Test>]
    member _.TestDerivativeMaxUnpool2D () =
        for combo in Combos.FloatingPointExcept16s do
            let indices = combo.tensor([[[[10, 21],
                                           [41, 45]],
                             
                                          [[ 8,  5],
                                           [40, 28]]],
                             
                             
                                         [[[ 8, 21],
                                           [32, 36]],
                             
                                          [[ 9, 13],
                                           [25, 27]]]], dtype=Dtype.Int32)
            let fwdx = combo.tensor([[[[1.8489, 1.1338],
                                         [0.6819, 1.6331]],
                           
                                        [[1.0867, 2.1048],
                                         [2.7646, 1.0156]]],
                           
                           
                                       [[[2.1120, 0.8666],
                                         [0.9141, 1.7133]],
                           
                                        [[1.4250, 1.8228],
                                         [1.2607, 0.5448]]]])
            let fwdx = fwdx.forwardDiff(combo.tensor([[[[ 1.3110,  1.5369],
                                                         [-0.4640,  0.1933]],
                                           
                                                        [[ 0.2313, -0.4964],
                                                         [-0.1616, -1.2032]]],
                                           
                                           
                                                       [[[ 0.0377,  2.1561],
                                                         [-0.3110, -1.6315]],
                                           
                                                        [[ 0.4036,  0.7063],
                                                         [ 0.0583,  1.8215]]]]))
            let fwdz = fwdx.maxunpool2d(indices, 3, outputSize=[2;2;8;8])
            let fwdzCorrect = combo.tensor([[[[0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 1.8489, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 1.1338, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 0.6819, 0.0000, 0.0000, 0.0000, 1.6331, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000]],
                                 
                                              [[0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 2.1048, 0.0000, 0.0000],
                                               [1.0867, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 1.0156, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [2.7646, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000]]],
                                 
                                 
                                             [[[0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [2.1120, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.8666, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [0.9141, 0.0000, 0.0000, 0.0000, 1.7133, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000]],
                                 
                                              [[0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 1.4250, 0.0000, 0.0000, 0.0000, 1.8228, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 1.2607, 0.0000, 0.5448, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000]]]])
            let fwdzd = fwdz.derivative
            let fwdzdCorrect = combo.tensor([[[[ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  1.3110,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  1.5369,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000, -0.4640,  0.0000,  0.0000,  0.0000,  0.1933,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000]],
                                   
                                                [[ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000, -0.4964,  0.0000,  0.0000],
                                                 [ 0.2313,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000, -1.2032,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [-0.1616,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000]]],
                                   
                                   
                                               [[[ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0377,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  2.1561,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [-0.3110,  0.0000,  0.0000,  0.0000, -1.6315,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000]],
                                   
                                                [[ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000,  0.4036,  0.0000,  0.0000,  0.0000,  0.7063,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0583,  0.0000,  1.8215,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                 [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000]]]])

            let revx = combo.tensor([[[[1.8489, 1.1338],
                                         [0.6819, 1.6331]],
                           
                                        [[1.0867, 2.1048],
                                         [2.7646, 1.0156]]],
                           
                           
                                       [[[2.1120, 0.8666],
                                         [0.9141, 1.7133]],
                           
                                        [[1.4250, 1.8228],
                                         [1.2607, 0.5448]]]]).reverseDiff()
            let revz = revx.maxunpool2d(indices, 3, outputSize=[2;2;8;8])
            let revzCorrect = combo.tensor([[[[0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 1.8489, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 1.1338, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 0.6819, 0.0000, 0.0000, 0.0000, 1.6331, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000]],
                                 
                                              [[0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 2.1048, 0.0000, 0.0000],
                                               [1.0867, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 1.0156, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [2.7646, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000]]],
                                 
                                 
                                             [[[0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [2.1120, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.8666, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [0.9141, 0.0000, 0.0000, 0.0000, 1.7133, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000]],
                                 
                                              [[0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 1.4250, 0.0000, 0.0000, 0.0000, 1.8228, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 1.2607, 0.0000, 0.5448, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                               [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000]]]])
            revz.reverse(combo.tensor([[[[ 0.8984, -0.1793, -0.6322, -0.0690, -0.9264,  0.0128, -0.7905, -1.1720],
                                          [-0.9698, -0.5440,  0.4486,  1.2180,  0.2225,  0.9609, -0.9034, -0.0780],
                                          [-0.4951,  0.8007,  0.9854,  0.0834, -0.6088, -0.0391, -1.2598,  0.9716],
                                          [ 0.3452, -0.8826, -0.6269,  0.2676, -0.7513, -1.2730,  1.3117, -1.0414],
                                          [-0.6497,  0.3582, -1.9917, -0.4683, -0.7881, -1.3295, -0.2698,  0.5392],
                                          [-0.5929,  0.5991, -0.9721,  3.0464, -0.4441, -2.0565, -1.5350, -2.4916],
                                          [-0.6468,  0.4241,  0.1965, -0.9907,  0.1452,  0.4475, -0.1735,  0.1073],
                                          [ 2.5096,  1.4079, -0.6148, -0.4607, -0.4818,  0.0415, -1.3375,  0.9602]],

                                         [[ 0.2130,  1.5446, -0.5831,  0.1359, -1.0135, -0.6529,  2.1866,  1.2187],
                                          [ 1.1122, -0.1649,  0.0473, -0.6117,  2.1489, -0.4845,  0.3153, -1.8326],
                                          [-1.9014, -0.3670,  0.8990, -0.4523,  0.3366, -1.0262,  1.0180, -1.6572],
                                          [-0.0980, -0.7111,  1.0891,  0.2800, -1.7344,  1.7927,  0.1482,  0.7804],
                                          [-0.2373,  0.1023, -0.4915, -0.7444,  1.1870, -0.2154,  2.6652, -0.5908],
                                          [ 0.1938,  0.7860, -0.2982,  0.3848,  0.6933,  0.0560,  0.3348, -1.7360],
                                          [ 1.6364,  0.0241,  0.5503,  1.0353,  0.2991, -0.0626, -0.1946, -0.8325],
                                          [ 0.2725, -1.0100, -1.0443, -0.1072, -0.7004, -1.5560,  1.2907, -0.4360]]],


                                        [[[-0.2089,  0.7702,  0.0477,  0.4665,  0.9363, -0.1614,  2.6186, -0.7527],
                                          [-1.1260, -1.0446, -1.1232, -1.4205, -0.5242, -0.6396,  1.2601,  0.6628],
                                          [-0.1578, -0.9871, -0.0246,  0.9263, -0.8434,  2.0567,  0.1197, -1.4947],
                                          [ 0.6996, -1.6738,  1.4169,  1.6045,  1.7552, -1.2681, -0.6705,  0.2275],
                                          [-0.8477,  0.2387,  2.1242, -1.0176, -0.6977, -1.1640, -0.6400, -0.5105],
                                          [-1.2159,  0.0419, -0.5746,  0.1896, -1.2158, -0.7044,  0.7461, -1.2746],
                                          [ 0.0053,  1.7733, -1.2196,  1.2569,  0.8448, -0.3330,  0.5204,  1.0973],
                                          [ 0.5777,  0.6732,  0.1366, -0.8237,  0.2497, -1.0159, -2.3620, -0.2002]],

                                         [[-0.3120, -0.2487, -0.3603,  0.2290, -1.3754,  0.1596, -0.1769, -1.2327],
                                          [-0.3505,  0.4122, -0.9472, -0.4892, -0.4146, -1.5960, -0.5563,  0.3567],
                                          [ 0.7608,  0.6693, -1.0732, -1.6005, -0.2449, -1.2722,  0.3509, -1.3285],
                                          [-1.1414,  0.0691,  1.0393,  1.2117, -0.1610,  0.7500,  0.3646,  0.4578],
                                          [ 1.2932,  0.4704,  1.3387,  0.8193,  1.8205, -0.0931,  0.0629, -0.1365],
                                          [ 0.5605,  0.6983, -1.1321, -1.4662,  2.1607,  0.1176,  0.0903,  0.7739],
                                          [ 0.3887,  0.3413,  0.4066,  0.8743,  3.5218, -0.4829, -0.8280, -1.2032],
                                          [ 0.8603, -0.4883,  0.0139,  0.4995,  1.0476, -2.1789,  0.1493,  1.1592]]]]))
            let revxd = revx.derivative
            let revxdCorrect = combo.tensor([[[[ 0.4486, -0.0391],
                                                 [ 0.5991, -2.0565]],
                                   
                                                [[ 1.1122, -0.6529],
                                                 [ 0.1938, -1.7344]]],
                                   
                                   
                                               [[[-1.1260,  2.0567],
                                                 [-0.8477, -0.6977]],
                                   
                                                [[ 0.4122, -1.5960],
                                                 [ 0.0691,  1.2117]]]])

            Assert.True(fwdz.allclose(fwdzCorrect, 0.01))
            Assert.True(fwdzd.allclose(fwdzdCorrect, 0.01))
            Assert.True(revz.allclose(revzCorrect, 0.01))
            Assert.True(revxd.allclose(revxdCorrect, 0.01))

    [<Test>]
    member _.TestDerivativeMaxPool3D () =
        for combo in Combos.FloatingPointExcept16s do
            let fwdx = combo.tensor([[[[ 0.4633,  0.9173,  0.4568, -1.7660, -0.1077],
                                         [-2.1112,  1.5542,  0.5720, -1.0952, -1.8144],
                                         [ 0.3505, -0.9843, -2.5655, -0.9835,  1.2303],
                                         [ 0.8156,  1.5415,  1.3066, -1.1820,  0.2060],
                                         [ 0.0684,  1.5936,  0.2956, -0.5176, -1.6960]],

                                        [[-1.7281, -0.7697, -2.2310,  0.3580,  0.6299],
                                         [ 0.8558, -0.6180, -1.6077, -0.6779,  1.2910],
                                         [ 0.1885, -0.7006, -0.1863, -1.6729, -0.5761],
                                         [ 0.1940, -0.0399,  0.9329,  1.0687,  0.0955],
                                         [-1.0189,  0.4046,  1.1762,  0.3842,  0.6831]],

                                        [[ 0.2996,  0.5738,  0.0369,  0.2835, -0.2363],
                                         [ 0.6847, -0.4949, -0.3974,  0.6808, -1.2942],
                                         [ 1.0910, -0.0594, -0.0037, -0.3355, -1.5056],
                                         [-0.0965,  1.1358,  1.2851, -1.7333, -1.1705],
                                         [ 0.0966, -1.2780,  1.2939,  1.3469, -0.2603]],

                                        [[-0.5270,  1.1442,  0.1259, -1.2813,  0.3536],
                                         [ 0.1579,  0.0828,  1.3531, -0.9110, -0.8747],
                                         [ 0.2473, -0.1507, -0.4880,  0.4575,  1.1186],
                                         [ 2.0900,  1.0479, -0.7209, -1.6928,  1.8761],
                                         [ 2.2015, -0.5097,  0.7364, -1.5177,  0.9212]],

                                        [[ 1.0358,  1.6584, -1.9654, -1.3971,  1.5641],
                                         [ 0.4032,  0.7737,  0.9351, -0.5245,  0.0783],
                                         [-1.2932, -0.9885, -1.1850, -0.7403,  0.1739],
                                         [-0.5471,  0.5017, -1.0571,  1.7574, -0.0911],
                                         [ 0.6944, -1.2772,  0.7473, -1.0983,  1.1462]]],


                                       [[[-1.2563,  0.0688,  1.0405, -0.2582,  0.7333],
                                         [ 2.0711, -0.1815,  0.8876, -0.2907,  1.1195],
                                         [-0.3912,  0.3624,  1.0576, -0.4748, -1.4021],
                                         [ 1.2176, -0.6160, -0.3471,  1.1689,  0.5677],
                                         [-0.0639,  0.3765, -0.2614,  1.8267,  0.0315]],

                                        [[ 1.2927,  1.0709, -0.8808,  0.8106, -0.5315],
                                         [ 0.7614, -0.3935,  1.2451, -0.0598, -0.5887],
                                         [-0.4089, -0.8598,  0.2478,  0.1282, -0.2745],
                                         [-0.4139, -1.2905, -0.2625, -2.0453,  1.8941],
                                         [-0.2400, -1.2830, -0.3503, -0.8536, -0.5927]],

                                        [[ 0.8200,  1.8860, -0.5216, -0.9590, -0.9760],
                                         [-1.5796,  2.2379, -0.5714, -1.5612,  1.4035],
                                         [-0.6434, -1.2257,  0.1408,  0.3781, -2.2344],
                                         [ 0.4963,  0.2431,  0.6835,  0.0047,  1.3374],
                                         [-1.5899,  2.5382,  0.9503,  1.9080,  1.8315]],

                                        [[ 0.5853,  1.9343, -0.7472,  2.1774, -2.1895],
                                         [-0.6187, -0.2870,  1.2485,  2.4069, -0.2632],
                                         [-1.6047, -0.3379,  0.5372,  1.7098,  1.6220],
                                         [ 0.5255,  0.2564, -1.8615,  1.5519, -0.5655],
                                         [-0.9452, -1.1828, -1.8192,  1.1349,  0.9806]],

                                        [[-1.8198,  0.5455,  1.1761,  1.3070, -0.4654],
                                         [ 1.2673,  0.2608,  0.8385, -1.0407, -0.6288],
                                         [-0.3860,  1.3343,  1.3084,  0.5794,  0.4639],
                                         [ 0.4750, -0.9006, -1.5002,  0.8689, -0.0379],
                                         [ 0.2891,  0.0195, -0.0503, -0.3235,  1.5407]]]]).unsqueeze(0)
            let fwdx = fwdx.forwardDiff(combo.tensor([[[[ 1.2061,  1.7293,  0.4767,  0.7229,  0.7488],
                                                          [ 0.6760, -0.0393, -0.8397,  0.8051,  0.4581],
                                                          [ 1.2460,  2.0884, -1.1798,  0.4861, -0.0964],
                                                          [ 0.3063,  0.4975,  0.6513,  0.1162,  0.3748],
                                                          [-1.2513, -0.5590,  1.5486, -0.6724,  1.1572]],
                                           
                                                         [[ 0.1752,  0.4672, -0.5822, -1.9512,  0.8160],
                                                          [ 1.7688,  0.8751, -0.1430, -0.2425,  0.0821],
                                                          [-0.2486,  0.3299,  0.5527, -2.1193,  0.4580],
                                                          [ 1.3704, -1.0868, -1.9629, -1.4430, -0.0127],
                                                          [ 1.7375, -1.3191, -0.5753, -1.9077, -0.3804]],
                                           
                                                         [[ 0.6108,  0.4258, -1.1079, -0.7524,  0.9564],
                                                          [-1.5938,  1.2050,  0.0338,  0.5924,  0.1084],
                                                          [ 0.8414, -0.0152, -0.4412,  1.1122, -1.9355],
                                                          [-0.1598, -0.6622,  0.3185, -0.1600,  0.1670],
                                                          [ 0.2093,  0.4207, -0.2291, -1.1138,  2.8360]],
                                           
                                                         [[ 0.6769,  1.6479, -1.2976,  0.8720,  0.8976],
                                                          [-0.6833, -1.4484, -0.3252, -1.4125, -0.6695],
                                                          [ 1.1028, -2.1919, -1.6716, -0.3574, -1.1171],
                                                          [-0.4295, -1.5260,  1.3498, -1.3144,  0.1886],
                                                          [ 2.1619,  0.8260,  0.0601, -0.7519, -1.3959]],
                                           
                                                         [[ 0.5264, -0.7098, -1.2012, -1.1240,  0.3372],
                                                          [-0.1811, -0.5194,  0.4035, -0.3355, -1.6033],
                                                          [-0.6442,  0.1703,  0.9095, -0.4948,  2.3665],
                                                          [ 0.1669,  0.1530, -0.2943,  1.5188, -1.5053],
                                                          [ 1.6047,  1.1917, -1.0954, -0.4808, -0.3117]]],
                                           
                                           
                                                        [[[-1.1625,  0.9542,  0.1126,  1.1992, -0.2086],
                                                          [ 1.0938, -1.4662,  0.4404,  0.0325,  0.2896],
                                                          [ 0.4777, -1.6264,  0.9373, -0.9954,  0.1160],
                                                          [ 1.7084, -1.0506, -0.7470,  1.6613, -0.0847],
                                                          [-2.1556, -0.4030,  0.2127, -0.0435,  1.1515]],
                                           
                                                         [[-0.4482,  1.7436,  0.5124,  0.1872, -0.8369],
                                                          [ 1.4735, -1.2213, -0.7122,  1.6542,  2.4351],
                                                          [-0.3379, -0.4623,  0.6521,  1.4995, -0.8807],
                                                          [-0.6245, -0.2797,  0.0155,  0.1932, -0.7321],
                                                          [-0.6612, -0.2360,  1.6194, -0.5233,  1.3992]],
                                           
                                                         [[-0.5477,  0.3180,  1.0264,  0.4323, -0.3248],
                                                          [ 0.7884,  0.4413,  1.3339,  2.2025,  1.0101],
                                                          [ 0.5930, -1.2639, -1.0836, -0.9338, -0.2644],
                                                          [ 0.9948, -0.9962, -1.1016,  2.2480, -1.9893],
                                                          [-0.2152, -0.1174,  0.6922, -2.1619,  0.0580]],
                                           
                                                         [[-0.4531,  0.1824, -0.4269, -1.1911,  2.4893],
                                                          [-0.8215, -1.3639, -0.1583, -0.1183, -0.1474],
                                                          [ 1.5304,  0.7693, -0.5337, -2.7162,  0.5287],
                                                          [-0.8808,  0.1495,  0.1766,  0.2239, -0.5056],
                                                          [ 1.2601, -0.4200, -0.3813, -0.2944,  1.4041]],
                                           
                                                         [[ 0.2880, -1.0861, -0.4530,  0.5327, -0.8753],
                                                          [ 0.5471,  0.3222,  1.7499, -0.5514,  0.7659],
                                                          [-1.8905, -0.6201,  0.6678,  1.4364, -0.5993],
                                                          [-0.6859, -0.3009,  0.4489, -1.1521,  0.9835],
                                                          [ 0.1159,  2.4556, -1.5528,  0.9735,  1.7658]]]]).unsqueeze(0))
            let fwdz = fwdx.maxpool3d(2)
            let fwdzCorrect = combo.tensor([[[[1.5542, 0.5720],
                                                [1.5415, 1.3066]],
                                 
                                               [[1.1442, 1.3531],
                                                [2.0900, 1.2851]]],
                                 
                                 
                                              [[[2.0711, 1.2451],
                                                [1.2176, 1.1689]],
                                 
                                               [[2.2379, 2.4069],
                                                [0.5255, 1.7098]]]]).unsqueeze(0)
            let fwdzd = fwdz.derivative
            let fwdzdCorrect = combo.tensor([[[[-0.0393, -0.8397],
                                                [ 0.4975,  0.6513]],
                                 
                                               [[ 1.6479, -0.3252],
                                                [-0.4295,  0.3185]]],
                                 
                                 
                                              [[[ 1.0938, -0.7122],
                                                [ 1.7084,  1.6613]],
                                 
                                               [[ 0.4413, -0.1183],
                                                [-0.8808, -2.7162]]]]).unsqueeze(0)

            let revx = combo.tensor([[[[ 0.4633,  0.9173,  0.4568, -1.7660, -0.1077],
                                         [-2.1112,  1.5542,  0.5720, -1.0952, -1.8144],
                                         [ 0.3505, -0.9843, -2.5655, -0.9835,  1.2303],
                                         [ 0.8156,  1.5415,  1.3066, -1.1820,  0.2060],
                                         [ 0.0684,  1.5936,  0.2956, -0.5176, -1.6960]],

                                        [[-1.7281, -0.7697, -2.2310,  0.3580,  0.6299],
                                         [ 0.8558, -0.6180, -1.6077, -0.6779,  1.2910],
                                         [ 0.1885, -0.7006, -0.1863, -1.6729, -0.5761],
                                         [ 0.1940, -0.0399,  0.9329,  1.0687,  0.0955],
                                         [-1.0189,  0.4046,  1.1762,  0.3842,  0.6831]],

                                        [[ 0.2996,  0.5738,  0.0369,  0.2835, -0.2363],
                                         [ 0.6847, -0.4949, -0.3974,  0.6808, -1.2942],
                                         [ 1.0910, -0.0594, -0.0037, -0.3355, -1.5056],
                                         [-0.0965,  1.1358,  1.2851, -1.7333, -1.1705],
                                         [ 0.0966, -1.2780,  1.2939,  1.3469, -0.2603]],

                                        [[-0.5270,  1.1442,  0.1259, -1.2813,  0.3536],
                                         [ 0.1579,  0.0828,  1.3531, -0.9110, -0.8747],
                                         [ 0.2473, -0.1507, -0.4880,  0.4575,  1.1186],
                                         [ 2.0900,  1.0479, -0.7209, -1.6928,  1.8761],
                                         [ 2.2015, -0.5097,  0.7364, -1.5177,  0.9212]],

                                        [[ 1.0358,  1.6584, -1.9654, -1.3971,  1.5641],
                                         [ 0.4032,  0.7737,  0.9351, -0.5245,  0.0783],
                                         [-1.2932, -0.9885, -1.1850, -0.7403,  0.1739],
                                         [-0.5471,  0.5017, -1.0571,  1.7574, -0.0911],
                                         [ 0.6944, -1.2772,  0.7473, -1.0983,  1.1462]]],


                                       [[[-1.2563,  0.0688,  1.0405, -0.2582,  0.7333],
                                         [ 2.0711, -0.1815,  0.8876, -0.2907,  1.1195],
                                         [-0.3912,  0.3624,  1.0576, -0.4748, -1.4021],
                                         [ 1.2176, -0.6160, -0.3471,  1.1689,  0.5677],
                                         [-0.0639,  0.3765, -0.2614,  1.8267,  0.0315]],

                                        [[ 1.2927,  1.0709, -0.8808,  0.8106, -0.5315],
                                         [ 0.7614, -0.3935,  1.2451, -0.0598, -0.5887],
                                         [-0.4089, -0.8598,  0.2478,  0.1282, -0.2745],
                                         [-0.4139, -1.2905, -0.2625, -2.0453,  1.8941],
                                         [-0.2400, -1.2830, -0.3503, -0.8536, -0.5927]],

                                        [[ 0.8200,  1.8860, -0.5216, -0.9590, -0.9760],
                                         [-1.5796,  2.2379, -0.5714, -1.5612,  1.4035],
                                         [-0.6434, -1.2257,  0.1408,  0.3781, -2.2344],
                                         [ 0.4963,  0.2431,  0.6835,  0.0047,  1.3374],
                                         [-1.5899,  2.5382,  0.9503,  1.9080,  1.8315]],

                                        [[ 0.5853,  1.9343, -0.7472,  2.1774, -2.1895],
                                         [-0.6187, -0.2870,  1.2485,  2.4069, -0.2632],
                                         [-1.6047, -0.3379,  0.5372,  1.7098,  1.6220],
                                         [ 0.5255,  0.2564, -1.8615,  1.5519, -0.5655],
                                         [-0.9452, -1.1828, -1.8192,  1.1349,  0.9806]],

                                        [[-1.8198,  0.5455,  1.1761,  1.3070, -0.4654],
                                         [ 1.2673,  0.2608,  0.8385, -1.0407, -0.6288],
                                         [-0.3860,  1.3343,  1.3084,  0.5794,  0.4639],
                                         [ 0.4750, -0.9006, -1.5002,  0.8689, -0.0379],
                                         [ 0.2891,  0.0195, -0.0503, -0.3235,  1.5407]]]]).unsqueeze(0).reverseDiff()
            let revz = revx.maxpool3d(2)
            let revzCorrect = combo.tensor([[[[1.5542, 0.5720],
                                                [1.5415, 1.3066]],
                                 
                                               [[1.1442, 1.3531],
                                                [2.0900, 1.2851]]],
                                 
                                 
                                              [[[2.0711, 1.2451],
                                                [1.2176, 1.1689]],
                                 
                                               [[2.2379, 2.4069],
                                                [0.5255, 1.7098]]]]).unsqueeze(0)
            revz.reverse(combo.tensor([[[[-0.5557,  0.7782],
                                          [ 1.2927,  0.9179]],
                           
                                         [[ 0.4852,  0.6701],
                                          [ 0.7996, -0.9707]]],
                           
                           
                                        [[[ 1.0630, -0.8899],
                                          [ 0.8771,  0.0433]],
                           
                                         [[ 0.3975,  0.0060],
                                          [-0.7735,  1.2806]]]]).unsqueeze(0))
            let revxd = revx.derivative
            let revxdCorrect = combo.tensor([[[[ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                  [ 0.0000, -0.5557,  0.7782,  0.0000,  0.0000],
                                                  [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                  [ 0.0000,  1.2927,  0.9179,  0.0000,  0.0000],
                                                  [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000]],
                                   
                                                 [[ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                  [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                  [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                  [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                  [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000]],
                                   
                                                 [[ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                  [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                  [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                  [ 0.0000,  0.0000, -0.9707,  0.0000,  0.0000],
                                                  [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000]],
                                   
                                                 [[ 0.0000,  0.4852,  0.0000,  0.0000,  0.0000],
                                                  [ 0.0000,  0.0000,  0.6701,  0.0000,  0.0000],
                                                  [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                  [ 0.7996,  0.0000,  0.0000,  0.0000,  0.0000],
                                                  [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000]],
                                   
                                                 [[ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                  [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                  [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                  [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                  [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000]]],
                                   
                                   
                                                [[[ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                  [ 1.0630,  0.0000,  0.0000,  0.0000,  0.0000],
                                                  [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                  [ 0.8771,  0.0000,  0.0000,  0.0433,  0.0000],
                                                  [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000]],
                                   
                                                 [[ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                  [ 0.0000,  0.0000, -0.8899,  0.0000,  0.0000],
                                                  [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                  [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                  [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000]],
                                   
                                                 [[ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                  [ 0.0000,  0.3975,  0.0000,  0.0000,  0.0000],
                                                  [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                  [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                  [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000]],
                                   
                                                 [[ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                  [ 0.0000,  0.0000,  0.0000,  0.0060,  0.0000],
                                                  [ 0.0000,  0.0000,  0.0000,  1.2806,  0.0000],
                                                  [-0.7735,  0.0000,  0.0000,  0.0000,  0.0000],
                                                  [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000]],
                                   
                                                 [[ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                  [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                  [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                  [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                  [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000]]]]).unsqueeze(0)

            Assert.True(fwdz.allclose(fwdzCorrect, 0.01))
            Assert.True(fwdzd.allclose(fwdzdCorrect, 0.01))
            Assert.True(revz.allclose(revzCorrect, 0.01))
            Assert.True(revxd.allclose(revxdCorrect, 0.01))

    [<Test>]
    member _.TestDerivativeMaxUnpool3D () =
        for combo in Combos.FloatingPointExcept16s do
            let indices = combo.tensor([[[[ 6,  7],
                                            [16, 17]],
                             
                                           [[76, 82],
                                            [90, 67]]],
                             
                             
                                          [[[ 5, 32],
                                            [15, 18]],
                             
                                           [[56, 83],
                                            [90, 88]]]], dtype=Dtype.Int32).unsqueeze(0)
            let fwdx = combo.tensor([[[[1.5542, 0.5720],
                                        [1.5415, 1.3066]],
                         
                                       [[1.1442, 1.3531],
                                        [2.0900, 1.2851]]],
                         
                         
                                      [[[2.0711, 1.2451],
                                        [1.2176, 1.1689]],
                         
                                       [[2.2379, 2.4069],
                                        [0.5255, 1.7098]]]]).unsqueeze(0)
            let fwdx = fwdx.forwardDiff(combo.tensor([[[[-1.3700, -0.2430],
                                                          [-1.2331,  1.3475]],
                                           
                                                         [[-0.4398, -1.9483],
                                                          [-0.3461, -0.0961]]],
                                           
                                           
                                                        [[[-0.3094, -0.8533],
                                                          [-1.5359,  0.6974]],
                                           
                                                         [[ 0.0174,  0.4181],
                                                          [-3.1010, -1.4052]]]]).unsqueeze(0))
            let fwdz = fwdx.maxunpool3d(indices, 2, outputSize=[1;2;5;5;5])
            let fwdzCorrect = combo.tensor([[[[0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 1.5542, 0.5720, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 1.5415, 1.3066, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000]],
                                 
                                               [[0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000]],
                                 
                                               [[0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 1.2851, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000]],
                                 
                                               [[0.0000, 1.1442, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 1.3531, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [2.0900, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000]],
                                 
                                               [[0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000]]],
                                 
                                 
                                              [[[0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [2.0711, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [1.2176, 0.0000, 0.0000, 1.1689, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000]],
                                 
                                               [[0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 1.2451, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000]],
                                 
                                               [[0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 2.2379, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000]],
                                 
                                               [[0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 2.4069, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 1.7098, 0.0000],
                                                [0.5255, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000]],
                                 
                                               [[0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000]]]]).unsqueeze(0)
            let fwdzd = fwdz.derivative
            let fwdzdCorrect = combo.tensor([[[[ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                [ 0.0000, -1.3700, -0.2430,  0.0000,  0.0000],
                                                [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                [ 0.0000, -1.2331,  1.3475,  0.0000,  0.0000],
                                                [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000]],
                                 
                                               [[ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000]],
                                 
                                               [[ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                [ 0.0000,  0.0000, -0.0961,  0.0000,  0.0000],
                                                [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000]],
                                 
                                               [[ 0.0000, -0.4398,  0.0000,  0.0000,  0.0000],
                                                [ 0.0000,  0.0000, -1.9483,  0.0000,  0.0000],
                                                [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                [-0.3461,  0.0000,  0.0000,  0.0000,  0.0000],
                                                [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000]],
                                 
                                               [[ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000]]],
                                 
                                 
                                              [[[ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                [-0.3094,  0.0000,  0.0000,  0.0000,  0.0000],
                                                [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                [-1.5359,  0.0000,  0.0000,  0.6974,  0.0000],
                                                [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000]],
                                 
                                               [[ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                [ 0.0000,  0.0000, -0.8533,  0.0000,  0.0000],
                                                [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000]],
                                 
                                               [[ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                [ 0.0000,  0.0174,  0.0000,  0.0000,  0.0000],
                                                [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000]],
                                 
                                               [[ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                [ 0.0000,  0.0000,  0.0000,  0.4181,  0.0000],
                                                [ 0.0000,  0.0000,  0.0000, -1.4052,  0.0000],
                                                [-3.1010,  0.0000,  0.0000,  0.0000,  0.0000],
                                                [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000]],
                                 
                                               [[ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
                                                [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000]]]]).unsqueeze(0)

            let revx = combo.tensor([[[[1.5542, 0.5720],
                                        [1.5415, 1.3066]],
                         
                                       [[1.1442, 1.3531],
                                        [2.0900, 1.2851]]],
                         
                         
                                      [[[2.0711, 1.2451],
                                        [1.2176, 1.1689]],
                         
                                       [[2.2379, 2.4069],
                                        [0.5255, 1.7098]]]]).unsqueeze(0).reverseDiff()
            let revz = revx.maxunpool3d(indices, 2, outputSize=[1;2;5;5;5])
            let revzCorrect = combo.tensor([[[[0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 1.5542, 0.5720, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 1.5415, 1.3066, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000]],
                                 
                                               [[0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000]],
                                 
                                               [[0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 1.2851, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000]],
                                 
                                               [[0.0000, 1.1442, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 1.3531, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [2.0900, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000]],
                                 
                                               [[0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000]]],
                                 
                                 
                                              [[[0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [2.0711, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [1.2176, 0.0000, 0.0000, 1.1689, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000]],
                                 
                                               [[0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 1.2451, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000]],
                                 
                                               [[0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 2.2379, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000]],
                                 
                                               [[0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 2.4069, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 1.7098, 0.0000],
                                                [0.5255, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000]],
                                 
                                               [[0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
                                                [0.0000, 0.0000, 0.0000, 0.0000, 0.0000]]]]).unsqueeze(0)
            revz.reverse(combo.tensor([[[[ 1.4996,  0.4412, -0.2222, -1.4660,  2.2101],
                                          [ 2.1833,  0.0253, -0.4618,  0.3705,  0.9694],
                                          [ 0.9886,  1.0174, -0.9824,  0.4999,  0.5915],
                                          [ 0.5233, -0.0890, -0.9260,  0.6011,  0.7426],
                                          [ 0.6975,  1.5036,  1.2356,  0.4051, -1.4870]],
                           
                                         [[ 0.9651, -0.4873,  0.0394,  1.6958, -0.3350],
                                          [-0.5239, -0.6556, -0.9611, -1.9268, -0.1635],
                                          [ 0.1487, -0.9833, -1.0552,  0.0662, -1.7744],
                                          [ 1.0557, -0.4365,  0.9221,  0.2850, -0.0438],
                                          [-0.5961, -0.4261,  0.7429,  0.9579,  0.1348]],
                           
                                         [[-0.2315, -0.3250, -2.0572,  0.4682,  0.0127],
                                          [ 0.5999,  1.1576,  0.4091, -0.6695,  0.4514],
                                          [-0.9583, -0.6140,  0.9052,  0.4652, -0.3354],
                                          [ 0.1565, -0.3522,  0.0414, -0.3546, -0.7299],
                                          [-1.1511, -1.5192,  0.6260, -0.7011,  0.4029]],
                           
                                         [[-0.3314,  1.1370, -0.5884,  0.5831,  0.3159],
                                          [ 0.5567,  0.5880,  0.8035,  0.5299, -1.3401],
                                          [-0.4984,  0.4939, -0.1194,  0.4468, -0.9184],
                                          [ 0.7292,  0.5066, -2.0562,  0.1669,  1.4641],
                                          [ 0.0156,  0.4129,  0.3488,  0.0692, -0.3184]],
                           
                                         [[ 0.8521,  0.8720,  0.4337,  0.5137,  1.2160],
                                          [-0.2332,  1.3707,  1.7794,  1.1254, -0.5471],
                                          [-0.9918, -0.1712,  0.8755, -0.9188,  1.1394],
                                          [-0.8296,  0.2991,  1.0070, -0.7850, -1.8599],
                                          [ 0.2952, -1.0716,  1.1704,  0.8802,  0.3842]]],
                           
                           
                                        [[[-0.0237,  0.7531, -0.2710,  1.1729, -0.7121],
                                          [ 0.9186,  1.2363, -0.1952, -0.0673,  1.0085],
                                          [-0.6230, -2.0113, -0.2770,  0.3931,  2.3753],
                                          [ 0.6668, -0.8795, -0.5598, -0.4569,  0.7753],
                                          [ 1.3866, -0.6705,  1.5111,  0.7448, -1.2024]],
                           
                                         [[-1.1604, -0.6232,  0.4849,  0.6395, -0.2678],
                                          [ 0.5002, -0.7866,  1.5850, -1.0708,  0.7870],
                                          [ 0.9380,  0.0941, -0.5031, -1.3665, -1.4975],
                                          [-0.0494, -0.1553, -0.7790, -0.0503,  0.1955],
                                          [-0.2318, -0.3391, -1.2539,  0.8975, -1.3006]],
                           
                                         [[-0.1324,  0.6140,  1.0129,  0.4974, -0.3212],
                                          [-1.4901,  0.8954,  0.1273,  1.4573, -1.0751],
                                          [-1.9942, -1.0629, -0.1082, -0.4686, -0.0412],
                                          [ 1.1362,  0.8016, -1.2716,  0.9211, -0.1257],
                                          [ 2.4162, -0.1040,  1.0381,  0.7080, -0.5832]],
                           
                                         [[-1.1875, -0.7901,  0.5196,  1.7849, -0.0865],
                                          [ 0.8591, -1.1806, -0.4879, -0.6041, -1.7609],
                                          [-0.1374, -1.0737,  0.7090,  0.5399, -0.4486],
                                          [ 0.0699, -0.9883, -0.7014, -0.8517, -1.0475],
                                          [ 0.1587,  0.8068,  0.8046, -1.1768,  0.4796]],
                           
                                         [[ 0.3587, -0.2504, -0.2464,  0.5278,  0.4445],
                                          [-0.6574, -1.4341,  1.0318, -1.1732,  0.8164],
                                          [ 0.6500,  0.4821, -1.0597, -0.7089, -1.4482],
                                          [-1.0141, -2.1376,  0.2760, -0.0456, -1.1903],
                                          [-1.9576,  0.6360,  2.3334,  1.0151,  0.1379]]]]).unsqueeze(0))
            let revxd = revx.derivative
            let revxdCorrect = combo.tensor([[[[ 0.0253, -0.4618],
                                                [-0.0890, -0.9260]],
                                 
                                               [[ 1.1370,  0.8035],
                                                [ 0.7292,  0.0414]]],
                                 
                                 
                                              [[[ 0.9186,  1.5850],
                                                [ 0.6668, -0.4569]],
                                 
                                               [[ 0.8954, -0.6041],
                                                [ 0.0699,  0.5399]]]]).unsqueeze(0)

            Assert.True(fwdz.allclose(fwdzCorrect, 0.01))
            Assert.True(fwdzd.allclose(fwdzdCorrect, 0.01))
            Assert.True(revz.allclose(revzCorrect, 0.01))
            Assert.True(revxd.allclose(revxdCorrect, 0.01))

